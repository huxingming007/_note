### 背景

随着数据库数据量的不断扩大，我们需要对数据库进行分库分表，达到分摊数据库压力以及减少数据库单表数据量的目的。分库分表带来的问题，原本单库的事务操作就变成了多库的事务操作，所以就造成了分布式事务的问题。

### 认识分布式事务

TM：协调者，统一调度AP，决定AP是否把事务提交到RM

AP：应用程序

RM：资源管理器，一般指的是数据库

#### 2pc

第一阶段：投票阶段

1. 事务询问，TM向AP发送事务内容
2. 执行事务，AP存储事务内容
3. 各个AP向TM反馈事务询问的响应

第二阶段：事务提交或者事务回滚

1. TM向所有AP发出commit请求或者rollback请求（当某个AP反馈了NO）
2. AP事务提交或者回滚
3. 反馈事务提交或者回滚结果
4. 完成事务或者中断事务

缺点：太过于保守（任意一个节点失败就会导致回滚），每一个阶段都是同步阻塞，性能开销很大，协调者存在单点问题，数据不一致（第二阶段协调者发送commit，只有部分AP收到，然后就挂了）

#### 3pc

解决2pc同步阻塞的问题

### 分布式事务

基于JTA规范的第三方分布式事务框架有Jotm和Atomikos。

CAP理论：一致性、可用性、分区容错性。因为网络分区的情况下，我们只能CP或者AP

BASE理论：最终一致性，允许出现中间状态

互联网行业的数据一致性问题解决方案：1、提供查询服务确认数据状态；2、幂等操作对于重发保证数据的安全性；3、TCC事务操作；4、补偿操作；5、定期校对；

#### TCC事务操作

支付宝架构师提出来的理论

1. Try：尝试执行业务
2. Confirm：确认执行业务
3. Cancel：取消执行业务

![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8jiyk7l3xj30u00ueten.jpg)

#### 业务接口整合，避免分布式事务

比方说，库存服务整合到订单服务里面。

#### 最终一致性方案

采用消息队列辅助实现事务控制流程

#### 关于状态机

比方说订单可能有几种状态：等待支付、支付中、支付失败、支付成功、退款中、退款成功、退款失败等等。作用：

1. 实现幂等
2. 通过状态驱动数据的变化
3. 业务流程更加清晰

#### 幂等

重复调用多次产生的业务结果与调用一次产生的业务结果相同；

1. 状态机实现幂等
2. 数据库唯一约束
3. tokenid的方式识别每次请求判断是否重复

#### 基于消息的最终一致性方案实践

可靠消息、最大努力通知（支付宝回调）。

![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8jj9w5m0yj31f00qm0ti.jpg)



![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8jjatxl22j30y30u0q44.jpg)

**可靠消息服务异常情况：**

1、轮训超时的待确认消息，调用上游业务判断是否已经执行，没有执行则删除消息，有执行则标记消息为已经发送并且发送到MQ中；

2、轮训超时的已发送消息，重新发送此消息到MQ中，下游应用应保持幂等性；

![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8jjaffcq7j31er0u0taa.jpg)

